#!/command/with-contenv bash
# shellcheck shell=bash

info() { echo "[config-watcher] $*"; }

info "Starting CUPS configuration watcher..."

# Wait until CUPS is running
while ! pgrep -x cupsd >/dev/null; do
    sleep 2
done

info "Watching /etc/cups for changes..."

# Watch for changes in CUPS config
inotifywait -m -e modify,create,delete,move /etc/cups /etc/cups/ssl 2>/dev/null | while read -r directory event filename; do
    info "Detected change: $event on $filename"
    
    # Debounce: wait 2 seconds for possible more changes
    sleep 2
    
    # Reload CUPS
    info "Reloading CUPS configuration..."
    /usr/local/bin/cups-reload.sh
    
    # Backup to persistent storage
    mkdir -p /data/cups/etc
    cp -rf /etc/cups/* /data/cups/etc/ 2>/dev/null || true
done
